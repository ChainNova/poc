define(["angular","lib/ajax-intercept"],function(e){var t=window,r=function(t){var r=t.data;if("object"==typeof r){r||(r={});var n=r.data||r.result||e.copy(r);return n._res=r,r.data=n,delete r.result,t.data=r,r}},n=function(e){var t=e.data,r=t.error_code||t.code,n=t.message||t.mag;return delete e.data,{error:t,error_code:r,error_msg:CORE.ERR(r)||CORE.ERR(n)||n||"未知错误，请稍后重试。"}};return e.module("ajax",["ajaxIntercept"]).config(["$httpProvider",function(e){e.interceptors.push(["$q",function(e){return{request:function(t){return t&&(t.headers||(t.headers={}),t.headers["X-Requested-With"]="XMLHttpRequest"),t||e.when(t)}}}]),e.interceptors.push(["$q",function(e){responseError=function(r,o,a){return o&&(o=n(o),a&&(o._OK=!0),r.data=o),r&&r.data&&"NOT_LOGIN"===r.data.error_code&&(t.Const.loginChecked=1,CORE.afterLogout()),e.reject(r)};var o={response:function(e){var t=r(e);if(t){if("error_code"in t.data||t.status&&t.status!==CORE.STATUSES.SUCCESS)return responseError(e,t,!0);t.status||200!=e.status||(t.status="success"),e.data=t.data,delete t.data}else e._OK=!0;return e},responseError:function(e){return responseError(e,r(e))}};return o}])}]).factory("ajax",["$http","$q","interceptServ",function(t,r,o){function a(t,r){var n,o=[],a=function(e,t){t=null==t?"":t,o[o.length]=encodeURIComponent(e)+"="+encodeURIComponent(t)};if(void 0===r&&(r=!1),e.isArray(t))e.forEach(t,function(e,t){a(e.name,e.value)});else for(n in t)i(n,t[n],r,a);return o.join("&").replace(c,"+")}function s(s){var c=r.defer(),u=r.defer(),i=c.promise;s.headers||(s.headers={}),"content-type"in s.headers||(s.headers["content-type"]="application/x-www-form-urlencoded; charset=UTF-8");var d=s.transformRequest||[];d.unshift(function(t,r){var n=r("content-type");if(e.isObject(t)&&n){if(n.match(/^application\/x-www-form-urlencoded/))return a(t);if(n.match(/^application\/json/))return e.toJson(t)}return t}),s.transformRequest=d,s.xsrfCookieName="_xsrf",i.success=function(e){return i.then(function(t){t&&e(t.data,t.status,t.headers,s)}),i},i.error=function(e){return i.catch(function(t){t&&e(t.data,t.status,t.headers,s)}),i},i.abort=function(e){return u.resolve(e||{}),i},i.setCategory=function(e){var t=f[e];return t||(t=f[e]=[]),s.category=e,t.push(i),i};var p=function(){i.abort=e.noop;var t=f[s.category];t&&(e.each(t,function(e,r){if(e===i)return t.splice(r,1),!1}),t.length||(t=f[s.category]=null))};s.method&&"get"!=s.method.toLowerCase()||(s.url+=(~s.url.indexOf("?")?"&":"?")+"ts="+(new Date).getTime()),s.timeout||(s.timeout=u.promise),s.category&&i.setCategory(s.category),_CORE=CORE,ERRORCODES=_CORE.ERRORCODES;var l=function(e){t(s).then(function(e){p(),c.resolve(e)}).catch(function(e){var t=e.data;if("object"==typeof t){var r=t.error._res;switch(r.status===_CORE.STATUSES.FAILED&&r.nick&&(Const.user||(Const.user={}),Const.user.nick=r.nick),t.error_code){case"REMOTE_ERROR":case"COOKIE_NOT_UNLOCK":case"ADMIN_COOKIE_NOT_UNLOCK":case"ACCOUNT_LOCK":case"ACCOUNT_DYNAMIC_LOCK":return void o.dialog(t,function(t,r,n){return r?(p(),void c.reject(e)):(l(n),i)})}}else e._OK||(e.data=n({data:{status:e.status,_res:{text:e.data},error_code:ERRORCODES.SERVER_ERROR}}));p(),c.reject(e)}).then(function(){e&&e()})};return l(),i}var c=/%20/g,u=/\[\]$/,i=function(t,r,n,o){var a;if(e.isArray(r))e.forEach(r,function(e,r){n||u.test(t)?o(t,e):i(t+"["+("object"==typeof e?r:"")+"]",e,n,o)});else if(!n&&e.isObject(r))for(a in r)i(t+"["+a+"]",r[a],n,o);else o(t,r)},f={};return["get","post","put"].forEach(function(e){s[e]=function(t,r,n){return"get"==e&&(n=r),n||(n={}),n.url=t,n.method=e,"get"!=e&&(n.data=r),s(n)}}),s.abort=function(t){var r=f[t];r&&e.isArray(r)&&(e.forEach(r,function(e){e.abort(),e=null}),r=f[t]=null)},s.param=a,s}])});