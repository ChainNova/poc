define(["angular","common/locales","jade!tmpl/intercept/unlock","jade!tmpl/intercept/smsauth","jade!tmpl/intercept/admin_unlock"],function(n,e,o,c,t){CORE.api.admin,e.get();n.module("ajaxIntercept",["dialog"]).factory("interceptServ",["$rootScope","$timeout","$interval","$dialog",function(n,e,r,i){var l={unlock:null,reauth:null,frozen:0},a=null,u=function(n,e){l.frozen++,a=CORE.msg(CORE.ERR(CORE.ERRORCODES.REMOTE_ERROR),"err"),setTimeout(function(){l.frozen--,e("retry").success(d).error(d)},5e3)},d=function(){l.frozen>0||!a||(CORE._killEle(a),l.frozen=0)},p=[],s=function(n,e){for(;p.length;)p.shift()(n,e)},f=function(n,e){p.push(e),l.adminunlock&&l.adminunlock.show()||(l.adminunlock=i.open({title:"Admin Unlock",dragable:!1,keyboard:!1,hideClose:!0,classname:"dialog3",template:t,onClose:function(){s(null,"canceled")},controller:["$scope","$timeout","ppServ",function(n,e,o){n.unlock={},n.doUnlock=function(){n.pending=!0,o.unlock(n.unlock.pay_pwd,function(e,o){return n.pending=!1,o?void(n.apiErr=o):(l.adminunlock.close(),s(e))})}}]}))},m=[],_=function(n,e){for(;m.length;)m.shift()(n,e)},h=function(n,e){m.push(e),l.reauth&&l.reauth.show()||(l.reauth=i.open({title:"提示",dragable:!1,keyboard:!1,hideClose:!0,classname:"dialog3",template:c,onClose:function(){_(null,"canceled")},controller:["$scope","$timeout","$interval","accountServ",function(e,o,c,t){e.frm={},e.flag=Number(n.error.dynamic_flag),e.flagName=0==e.flag?"支付密码":"动态验证",e.confirm=function(){e.pending=!0,t.verifySMSCode(e.frm.code,function(n,o){return e.pending=!1,o?e.apiErr=o:(l.reauth.close(),_(n))})},cd=function(n){n?e.cd=n:e.cd--,e.cd&&o(cd,1e3)},e.getVcode=function(){e.vcodePending=!0,delete e.apiErr,t.sendSms("","",function(n,o){if(e.vcodePending=!1,cd(60),o)return e.apiErr=o})}}]}))},g=[],C=function(n,e){for(;g.length;)g.shift()(n,e)},k=function(n,e){var c="ACCOUNT_DYNAMIC_LOCK"==n.error_code?1:0;g.push(e),l.unlock&&l.unlock.show()||(l.unlock=i.open({title:"操作前须解锁.",classname:"dialog3",template:o,onClose:function(){C(null,"canceled")},controller:["$scope","$timeout","$interval","accountServ",function(n,e,o,t){var r=n.hasGAuth=Const.user.hasSetGoogleAuth,i=n.hasPhonePwd=Const.user.hasSetPhonePassword||c;cd=function(o){o?n.cd=o:n.cd--,n.cd&&e(cd,1e3)},n.confirm=function(){_pay_pwd=n.unlock.pay_pwd,_phone_pwd="",(r||i)&&(_pay_pwd=n.unlock.pay_pwd,_phone_pwd=n.unlock.password_pay),n.pending=!0,t.userUnlock(_pay_pwd,_phone_pwd,c,function(e,o){return n.pending=!1,o?n.apiErr=o:(l.unlock.close(),void C(e))})},n.getVcode=function(){n.vcodePending=!0,delete n.apiErr,t.sendSms("","",function(e,o){if(n.vcodePending=!1,cd(60),o)return n.apiErr=o})}}]}))};return{dialog:function(n,e){switch(n.error_code){case"ACCOUNT_LOCK":case"ACCOUNT_DYNAMIC_LOCK":k(n,e);break;case"COOKIE_NOT_UNLOCK":h(n,e);break;case"ADMIN_COOKIE_NOT_UNLOCK":f(n,e);break;case"REMOTE_ERROR":u(n,e)}}}}])});