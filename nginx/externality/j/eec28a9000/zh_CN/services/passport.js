define(["common/module","common/locales","jade!tmpl/passport","components/pwd-strength","components/markup","services/pp"],function(n,o,r){var e,t,i,a,c,s;return s=o.get(!0),e="passport",t={login:"登录",signup:"注册"},c=function(n){return t[n]||t.login},a="passportCtrl",i=["$scope","$rootScope","passportServ","$location","$route","ppServ","$timeout","$sce",function(n,o,r,e,i,a,c,s){var l,u,p,f,g,d,h;return n.conf=u={needMobi:!1},p="news.read",g=5,f=CORE.LS.get(p),g>f&&(o.hasNew=!0),o.newsShow=0,o.toggleNewsShow=function(n,r){return r?o.newsShow=0:(o.newsShow=o.newsShow?0:1,f!==g?(CORE.LS.set(p,g),delete o.hasNew):void 0)},n.PP=l=r.PP(),d=e.search(),d.passport&&(l.action=d.passport),n.formData={},n.$watch("PP.action",function(e){if(e&&t[e])return n.apiErr=!1,r.search(e),o.passportName=t[e]}),h=function(n){var t,i,a;return t=e.search(),(i=n.callback||t.callback)?CORE.redirect2(i,1):(a=!0,!a&&n.userInfo.emailNotActivated?(e.search({passport:"activate",email:n.userInfo.email}),void(o.$$phase||o.$apply())):"signup"===l.action?void r.search("login"):t.c?CORE.redirect2(t.c,1):r.inPage()?CORE.redirect2("/",1):(r.search(null),null))},n.login=function(){return n.pending=!0,a.login(n.formData,function(o,r){return n.pending=!1,r?n.apiErr=r:(l.dialog&&l.dialog.close(),h(o))})},n.signup=function(){return n.pending=!0,n.apiErr=!1,a.signup(n.formData,function(o,r){return n.pending=!1,r?n.apiErr=r:(l.dialog&&l.dialog.close(),h(o))})}}],n.factory("passportServ",["$rootScope","$location","$dialog",function(n,o,a){var s,l,u,p;return s={dialog:null,action:null},p=function(r){if(o.search(e,r),!n.$$phase)return n.$apply()},l=function(){return/^\/passport/.test(location.pathname)},n.$on("$locationChangeSuccess",function(n,r,e){var i,a;if(i=o.search().passport){if(i===s.action)return;t[i]||(i="login"),s.action=i,p(s.action)}else if(!(null!=(a=Const.user)?a.enrollId:void 0))return u()}),n.$watch("Const.user.enrollId",function(n){var r;return n?(r=o.search().passport,s.dialog&&"activate"===r?(s.dialog.close(),p(null)):l()&&!~["reset","signup"].indexOf(r)?p("login"):void 0):u()}),n.$on("after-logout",function(){return u()}),u=function(n,e){var t,u;if(t=o.search(),l()&&!t.passport)return p("login");if(Const.loginChecked){if(n){if(s.action===n)return;s.action=n}else if(s.action)return;switch(CORE.pathNeedLogin()){case 1:return CORE.redirect2Login(1);case 0:if(l())return p({passport:s.action});if(e)return CORE.redirect2Login(1);break;case-1:if(null!=(u=s.dialog)?u.show():void 0)return;return s.dialog=a.open({title:c(s.action),classname:"dialog3",template:'<div class="dialogC">'+r+"</div>",controller:i,onClose:function(){return p({passport:null})}})}}},{inPage:l,search:p,PP:function(){return s},open:u,login:function(){return u("login")},signup:function(){return u("signup")},forgot:function(){return u("forgot")},recovery:function(){return u("recovery")}}}]).controller(a,i),{controller:i,tmpl:r,ctrl:a}});