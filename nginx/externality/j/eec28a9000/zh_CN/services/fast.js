define(["common/module","common/moment","worker/keeper","lib/unifyTrade","services/pair"],function(e,r,n,t){var u,o,a,c,s;return s=n("tx"),c=200,a=angular.noop,o=function(e,n){var t;return t=r.utc("2000-01-01T00:00:00-08:00").add(1e3*e),n?t.format(n):t},u={held:{code:0},deal:{code:1},expire:{code:2},canceled:{code:3}},e.factory("fastServ",["ajax","$timeout","$rootScope","pairServ","ConstServ",function(e,n,o,c,l){var i,d,f,m,p,y,h,O,b,k,v,x,g,C,w,S,E,R,$,T,N,j,q,I,_;return v=c.fast,m=CORE.api.trade,p=CORE.api.ws,y=CORE.api.charts,$={headers:{"content-type":"application/json"}},R=function(){var e;return e={pair:v.pair,markets:{ts:null,close:null,volume:null,topn:[],max:40,high:null,low:null,latest:null},myOrders:{heldTS:null,held:null,dealt:null,dealtNew:0,awaits:[]},book:{watcher:null,unclosed:[],offer:{depth:6,ts:null,bids:[],asks:[],index:{latest:0,current:0}}}}},O=R(),o.$watch("fast.pair",function(e){var r;if(e){if(!O.pair)return O.pair=e;if(!angular.equals(e,O.pair))return O.pair=e,r=O.book.offer,r.ts&&(r.bids.length=0,r.asks.length=0,r.index.latest=0,r.index.current=0,g()),o.$$phase?void 0:o.$apply}}),o.$watch("Const.user.enrollId",function(e,r){if((!e&&r||e&&r&&e!==r)&&(O.myOrders.held=null,w(),O.myOrders.dealt))return O.myOrders.dealt=null,O.myOrders.dealtNew=0,O.myOrders.awaits.length=0,C()}),N=function(e){var r;if(r=O.myOrders.awaits.indexOf(e),~r)return O.myOrders.awaits.splice(r,1)},j=null,x=function(e){return n.cancel(j),j=n(g,e||5e3)},i=null,h=!1,g=function(r,n){var u,o;if(!h||O.book.offer.ts)return h=!0,n||(n=a),i&&O.book.offer.ts&&i.abort(),o=CORE.j2r([v.base.currency,v.trade.currency,r||20]),u=O.book.offer,u.index.current=0,i=e.get(m+"tx/market/"+o).success(function(e){return t.mergeOffers(O.book.offer,e),u.ts=CORE.ts(),x(3e3),n(e)}).error(function(e){return n(null,e),h&&!u.ts&&(h=!1),x(1e3)})},I=null,E=!1,w=function(){var r,t;if(!E)return E=!0,n.cancel(I),r=u.held,t=100,e.get(m+"tx/my/"+r.code+"/"+t+"/").success(function(e){return s.req({type:"offers_held",data:e.orders,cb:function(e){return O.myOrders.held=e,O.myOrders.heldTS=CORE.ts()}})}).finally(function(){return E=!1,n.cancel(I),I=n(w,3e3)})},q=null,k=!1,C=function(){var r,t;if(!k)return k=!0,n.cancel(q),r=u.deal,t=100,e.get(m+"tx/my/"+r.code+"/"+t+"/").success(function(e){return s.req({type:"offers_dealt",data:e.orders,cb:function(e){return O.myOrders.dealt=e}})}).finally(function(){return k=!1,n.cancel(q),q=n(C,3e3)})},_=function(e,r){var n;return n=O.markets,r&&(n.topn.length=0),[].unshift.apply(n.topn,e.txs),n.topn.length>n.max&&(n.topn.length=n.max),n.open=e.o,n.high=e.h,n.low=e.l,n.close=e.c,n.volume=e.v,n.latest=n.topn[0],n.ts=CORE.ts()},d=null,f=!1,S=function(n){var t,u;if(!f||O.markets.latest)return d&&d.abort(),f=!0,t=O.markets,u={base:v.base,counter:v.trade,limit:n||t.max,reduce:!1,descending:!0,endTime:r().toISOString(),startTime:r().subtract(3,"d").toISOString()},d=e.post(y+"offersExercised",u,$).success(function(e){return _(e,!0)}).finally(function(){return f=!1})},T=function(r,n,t,u){var o;return r=Number(r),n=Number(n),o={isBuyAll:"buy"===t},"buy"===t?(o.srcCurrency=v.trade.currency,o.srcCount=n,o.desCurrency=v.base.currency,o.desCount=r):(o.srcCurrency=v.base.currency,o.srcCount=r,o.desCurrency=v.trade.currency,o.desCount=n),e.post(m+"tx/exchange",o,$).success(function(e){return u(e),w()}).error(function(e){return u(null,e)})},b=function(r,n){var t;return t={uuid:r},e.post(m+"tx/cancel",t,$).success(function(e){return n(e)}).error(function(e){return n(null,e)})},{markets:{topn:function(e){var r;return(null!=(r=O.markets.topn)?r.length:void 0)||S(),O.markets}},myOrders:function(e){switch(e){case"held":O.myOrders[e]||w();break;case"dealt":O.myOrders[e]||C()}return O.myOrders},book:function(e,r){return O.book.offer.ts||g(),O.book},trader:function(){return O.trader},makeOffer:T,cancelOffer:b}}])});