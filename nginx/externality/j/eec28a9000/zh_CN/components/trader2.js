define(["common/module","jade!tmpl/trader2","services/fast","services/balance","services/coin"],function(e,r){return e.directive("ngdTrader2",["fastServ","$rootScope","$timeout","coinServ",function(e,t,a,n){var i;return i=1.1,{scope:{showType:"@ngdMyOrdersType",widgetType:"@"},restrict:"A",transclude:!0,template:r,link:function(r,n,i,c){var l,u,o,s,m,p,b,d,f,v,y,w;return r.exTypes=u=[{name:"限价",val:"limit"},{name:"市价",val:"market"}],r.exType=u[0].val,r.Fee=0,r.Min=1e-4,r.Const=Const,r.buy={},r.sell={},r.limit={},r.fast=o=t.fast,d=e.book().offer,b=r.myOrders=e.myOrders(),r.traderTypes=w=[{name:"限价",val:"limit"},{name:"市价",val:"market"}],r.traderType=w[0].val,r.chgType=function(e){return r.traderType=e,y("base"),y("trade")},s=function(e){return"buy"===e?"trade":"base"},p=function(e){return"base"===e?"sell":"buy"},v=function(e){var r,t,a;return t=o[e],a=l[e],t.available?a.available=t.available:(r=new BN(t.balance).sub(a.locked),a.available=r<0?0:r.toNumber(t.precision)),y(e)},r.$watch("fast.pair",function(e){return f("buy"),f("sell")}),r.balance=l={base:{locked:new BN(0),available:0,rest:0,sum:0,overflow:!1},trade:{locked:new BN(0),available:0,max:null,rest:0,sum:0,overflow:!1}},r.$watchGroup(["fast.base.balance","Const.user.restrictPrice","sell.price"],function(e){return v("base")}),r.$watch("fast.trade.balance",function(e){return v("trade")}),r.$watch("myOrders.heldTS",function(e){}),y=function(e){var t,a,n,i,u,s,b;switch(b=p(e),a=o[e],c=r[b],t=new BN(l[e].available),n=0,s=0,u=function(a,i,c){var u,o,s,m;if("sell"===c&&(u=o=!1,Const.user.offerQuota&&(s=Number(Const.user.offerQuota),m=new BN(s),o=m.cmp(t)<0),"limit"===i&&(u=Const.user.restrictPrice&&r.sell.price&&r.sell.price<Const.user.restrictPrice,o=!0),"market"===i&&(u=!0),r.restricted=u&&o,r.restricted&&(l[e].available=s,t=m)),n=t.sub(a),"limit"===i&&n.cmp(t)>0)return n=new BN(0)},r.traderType){case"limit":s=new BN(c.amount||0),i="buy"===b?s=s.mul(c.price||0):s.mul(c.price||0),u(s,r.traderType,b);break;case"market":i=s=new BN(c.total||0),"sell"===b&&(i=i.mul(m("buy"))),u(s,r.traderType,b)}return l[e].sum=i.toNumber(o.trade.precision),l[e].rest=n.toNumber(a.precision),l[e].overflow=n.cmp(0)<1,l[e]},f=function(e){return"buy"===e?(r.buy.price=r.buy.amount=r.buy.total="",r.check("buy","price")):(r.sell.price=r.sell.amount=r.sell.total="",r.check("sell","price"))},r.check=function(e,t){var a,n,i;if(a=s(e),n=y(a).overflow,c=r[e],i="buy"===e?o.base.precision:o.trade.precision,"buy"===e&&"price"===t)return l.trade.max=new BN(l.trade.available).div(c.price).toString(i)},m=function(e){var r,t;return"buy"===e?new BN(1.1).mul((null!=(r=d.asks[0])?r.showPrice:void 0)||0):new BN(.9).mul((null!=(t=d.bids[0])?t.showPrice:void 0)||0)},r.make=function(t){var a,n,i,c,l,u;switch(i=r[t],n=r.ask,c="buy"===t?o.base.precision:o.trade.precision,r.traderType){case"limit":a=i.amount,l=i.price,u=new BN(l).mul(a).toString();break;case"market":"buy"===t?(u=i.total,l=m("buy"),a=new BN(u).div(l).toString()):(a=i.total,l=m("sell"),u=l.mul(a).toString())}return i.pending=!0,e.makeOffer(a,u,t,function(e,t){var a;if(i.pending=!1,t)return a=CORE.ERR(t.error_code)||t.error_msg||t.error_code,CORE.msg(a,"warn");switch(CORE.msg("您的订单已提交.","ok"),r.traderType){case"limit":return i.price=i.amount="";case"market":return i.total=""}})},r.$on("fill-trader",function(e,t){var n,i,u,o,m,p,b,d,f,v;return v=t[0],p=t[1],i=t[2],f=t[3],m=s(v),"buy"===v&&(d=BN.ROUND_UP),f?f!==r.traderType&&(r.traderType=f):r.traderType=w[0].val,c=r[v],u="limit"===r.traderType?"amount":"total",p&&(n=new BN(p).toPrice(d).replace(/,/g,""),c.price=Number(n)),b=o=new BN(l[m].available),c.price&&"buy"===v&&(b=o.div(c.price)),new BN(i).cmp(b)>0&&(i=b),i&&(c[u]=new BN(i).toNumber(6)),a(function(){return r.check(v,"price")})})}}}])});